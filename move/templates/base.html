<!DOCTYPE html>
{% load static %}
{% load bootstrap4 %}
{% load leaflet_tags %}

<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    {% leaflet_js %}
    {% leaflet_css %}
    <!-- Load static css -->
    <link rel="stylesheet" href="{% static "css/style.css" %}"/>
    <!-- Load Esri Leaflet from CDN -->
    <script
      src="https://unpkg.com/esri-leaflet@3.0.14/dist/esri-leaflet.js"
      integrity="sha512-3fIGJwUOdCnUZPv8vIk8CMi3baMSaQp/zozG6kRGM4f5NvSXKBRNf4ufcdP94Nii510v1tfsXR1HScEg7WU3Pg=="
      crossorigin=""></script>
    <!-- Leaflet pour label -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-textpath@1.2.0/leaflet.textpath.min.js"></script>
    <!-- Latest compiled Bootsrtap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
    integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <!-- Alternative to Bootstrap 3 Glyphicons -->
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <title>MOVE</title>
  </head>
  <body>
  <div>
    {% block content %}
    {% endblock %}
  </div>
</body>

  <!-- Latest compiled and minified jQuery -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>
  <script type="text/javascript">
    // On définit une boucle qui parcourera une liste contenant les fichiers json
    var dataurl = '{% url "point_data" %}' ;
    window.addEventListener("map:init", function (event) {
      //Définition des variables globales
      var map = event.detail.map;
      var lc = map.layerscontrol;
      var control;
      var content;
      // Téléchargement des fichiers GEOJSON avec Ajax
      var file = fetch(dataurl).then(function(resp) {
          return resp.json();
        });
      // Définition de la symbologie pour les marqueurs
      function markers(feature, latlng){
        var props = feature.properties;
        var geoOptions = {
          color:"orange",
          radius: 4,
          fillOpacity: 0.8
        };
        return L.circleMarker(latlng, geoOptions);
      };
      // Définiton des popups et affichage des couches
      file.then(function(data) {lc.addOverlay(
        L.geoJson(data, {pointToLayer : markers,
          onEachFeature: function onEachFeature(feature, layer) {
            var props = feature.properties;
            control = 'Point de vente';
            content = ` <h4>Point de vente</h4>
                        <h6><b>Nom:</b> ${props.p102}</h6>
                        <h6><b>Tel:</b> ${props.p103}</h6>
                        <h6><b>Genre:</b> ${props.p8}</h6>
                        <h6><b>Age:</b> ${props.p16}</h6>
                        <h6><b>Nationalité:</b> ${props.p17}</h6>
                        <h6><b>Biens/Services:</b> ${props.p15}</h6>
                        <h6><b>Activité Principale?:</b> ${props.p26}</h6>
                        <h6><b>Fixe ou Mobile:</b> ${props.p10}</h6>
                        <div class="d-flex justify-content-center">
                          <a class="detail btn btn-primary mx-1" href="https://informallcity-production.up.railway.app/admin/move/point_vente/${props.p1}/change/">Détails <i class="fa fa-arrow-right" aria-hidden="true"></i></a>
                        </div>`;
            layer.bindPopup(content);
        }}).addTo(map),control);
      });
    });
  </script>

</html>
